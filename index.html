<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farming Broker ‚Ä¢ Farmer</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LINE LIFF v2 -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* mobile safe area + sticky bottom nav */
    .safe { padding-bottom: env(safe-area-inset-bottom); }
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .btn  { @apply w-full py-3 rounded-xl font-semibold; }
    .btn-primary { @apply bg-green-600 text-white active:opacity-90; }
    .btn-outline { @apply border border-gray-300 bg-white; }
    .badge      { @apply inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-sm mx-auto min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur sticky top-0 z-20 border-b">
      <div class="px-4 py-3 flex items-center gap-3">
        <img id="userAvatar" class="w-9 h-9 rounded-full hidden" alt="">
        <div class="flex-1">
          <div class="text-sm text-gray-500">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</div>
          <div id="userName" class="font-semibold">Farmer</div>
        </div>
        <button id="openProfile" class="text-sm text-gray-600 underline">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      </div>
    </header>

    <!-- Pages -->
    <main class="flex-1 px-4 py-4 space-y-4">

      <!-- Home -->
      <section id="page-home" class="space-y-4">
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div id="homeStatus" class="mt-1 text-lg font-semibold">‚Äî</div>
              <div id="homeExplain" class="text-xs text-gray-500">‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
            </div>
            <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/plant.svg" class="w-12 h-12 opacity-70" />
          </div>
          <div class="mt-4 grid grid-cols-2 gap-2">
            <button class="btn btn-primary" onclick="nav('status');checkStatus()">‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</button>
            <button class="btn btn-outline" onclick="nav('register')">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button class="btn btn-outline" onclick="nav('offer');prefillOffer()">‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</button>
            <button class="btn btn-outline" onclick="nav('deals')">‡∏î‡∏µ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
          </div>
        </div>

        <div class="card">
          <div class="font-semibold mb-2">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <ul id="homeNews" class="text-sm text-gray-600 list-disc pl-5 space-y-1">
            <li>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß</li>
          </ul>
        </div>
      </section>

      <!-- Register Plot -->
      <section id="page-register" class="hidden space-y-4">
        <div class="card">
          <div class="font-semibold mb-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</div>
          <form id="formRegister" onsubmit="registerParcel(event)">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-500">‡∏û‡∏∑‡∏ä</label>
                <select id="crop" class="w-full mt-1 border rounded-lg p-2">
                  <option>‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î</option>
                  <option>‡∏Ç‡πâ‡∏≤‡∏ß</option>
                  <option>‡∏≠‡πâ‡∏≠‡∏¢</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î (‡πÑ‡∏£‡πà)</label>
                <input id="sizeRai" type="number" step="0.1" class="w-full mt-1 border rounded-lg p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.5" />
              </div>
              <div class="col-span-2">
                <label class="text-xs text-gray-500">‡∏û‡∏¥‡∏Å‡∏±‡∏î</label>
                <div class="mt-1 flex gap-2">
                  <input id="lat" class="flex-1 border rounded-lg p-2" placeholder="lat" />
                  <input id="lng" class="flex-1 border rounded-lg p-2" placeholder="lng" />
                  <button type="button" class="px-3 rounded-lg border" onclick="grabGPS()">üìç</button>
                </div>
              </div>
              <div class="col-span-2">
                <label class="text-xs text-gray-500">‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏á (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <input id="photo" type="file" accept="image/*" class="w-full mt-1" />
              </div>
            </div>
            <button class="btn btn-primary mt-4" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </form>
        </div>
      </section>

      <!-- Status -->
      <section id="page-status" class="hidden space-y-4">
        <div class="card">
          <div class="flex items-center justify-between">
            <div class="font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</div>
            <button class="text-sm underline" onclick="checkStatus()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <span id="statusBadge" class="badge bg-gray-200 text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‚Ä¶</span>
            <span id="statusText" class="text-sm text-gray-600">‚Äî</span>
          </div>
          <div class="mt-3 grid grid-cols-3 text-center">
            <div>
              <div class="text-xs text-gray-500">NDWI</div>
              <div id="ndwi" class="font-semibold">‚Äî</div>
            </div>
            <div>
              <div class="text-xs text-gray-500">LSWI</div>
              <div id="lswi" class="font-semibold">‚Äî</div>
            </div>
            <div>
              <div class="text-xs text-gray-500">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</div>
              <div id="updated" class="font-semibold">‚Äî</div>
            </div>
          </div>
          <button class="btn btn-outline mt-4" onclick="shareStatus()">‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÅ‡∏ä‡∏ï</button>
        </div>
      </section>

      <!-- Request Offer -->
      <section id="page-offer" class="hidden space-y-4">
        <div class="card">
          <div class="font-semibold mb-3">‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</div>
          <form id="formOffer" onsubmit="createOffer(event)">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)</label>
                <input id="qtyTon" type="number" step="0.1" class="w-full mt-1 border rounded-lg p-2" />
              </div>
              <div>
                <label class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</label>
                <input id="moisture" type="number" step="0.1" class="w-full mt-1 border rounded-lg p-2" />
              </div>
              <div class="col-span-2">
                <label class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <input id="note" class="w-full mt-1 border rounded-lg p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤" />
              </div>
            </div>
            <button class="btn btn-primary mt-4" type="submit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
          </form>
        </div>
      </section>

      <!-- Deals -->
      <section id="page-deals" class="hidden space-y-3">
        <div class="card">
          <div class="font-semibold mb-2">‡∏î‡∏µ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
          <div id="dealList" class="space-y-2 text-sm text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏µ‡∏•</div>
        </div>
      </section>

      <!-- Profile Sheet (simple) -->
      <section id="page-profile" class="hidden space-y-4">
        <div class="card">
          <div class="font-semibold mb-2">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
          <div id="profileBox" class="text-sm text-gray-700">‚Äî</div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <button class="btn btn-outline" onclick="liff.logout(); location.reload()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn btn-outline" onclick="nav('home')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          </div>
        </div>
      </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="safe sticky bottom-0 z-20 bg-white border-t">
      <div class="max-w-sm mx-auto grid grid-cols-4 text-center">
        <button class="py-3 text-sm" onclick="nav('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="py-3 text-sm" onclick="nav('register')">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button class="py-3 text-sm" onclick="nav('status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
        <button class="py-3 text-sm" onclick="nav('deals');loadDeals()">‡∏î‡∏µ‡∏•</button>
      </div>
    </nav>
  </div>

  <script>
    // ====== CONFIG ======
    const LIFF_ID  = "PUT_YOUR_LIFF_ID_HERE";
    const API_BASE = "https://your-api.example.com"; // <- change to your backend

    // ====== STATE ======
    const state = { userId: null, idToken: null, parcels: [], currentParcelId: null };

    // ====== NAV ======
    function nav(page) {
      for (const el of document.querySelectorAll('main > section')) el.classList.add('hidden');
      document.getElementById(`page-${page}`).classList.remove('hidden');
      if (page === 'profile') loadProfile();
    }

    // ====== HELPERS ======
    async function fetchJSON(path, opts={}) {
      const headers = Object.assign({ "Content-Type": "application/json" }, opts.headers||{});
      if (state.idToken) headers["Authorization"] = "Bearer " + state.idToken;
      const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function setBadge(el, label, tone) {
      el.className = "badge " + ({
        good:  "bg-green-100 text-green-700",
        warn:  "bg-yellow-100 text-yellow-700",
        bad:   "bg-red-100 text-red-700",
        info:  "bg-gray-200 text-gray-700"
      }[tone] || "bg-gray-200 text-gray-700");
      el.textContent = label;
    }

    // ====== INIT LIFF ======
    (async () => {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      state.idToken = liff.getIDToken();
      const prof = await liff.getProfile();
      state.userId = prof.userId;
      document.getElementById('userName').textContent = prof.displayName || 'Farmer';
      const ava = document.getElementById('userAvatar');
      if (prof.pictureUrl) { ava.src = prof.pictureUrl; ava.classList.remove('hidden'); }
      // preload parcels
      try {
        const me = await fetchJSON(`/farmers/me`);
        state.parcels = me.parcels || [];
        state.currentParcelId = state.parcels[0]?.id || null;
      } catch (e) {}
      nav('home');
    })();

    // ====== PROFILE ======
    async function loadProfile() {
      const prof = await liff.getProfile();
      document.getElementById('profileBox').innerHTML = `
        <div>‡∏ä‡∏∑‡πà‡∏≠: <b>${prof.displayName}</b></div>
        <div class="text-xs text-gray-500 break-all">userId: ${state.userId || "-"}</div>
      `;
    }
    document.getElementById('openProfile').onclick = () => nav('profile');

    // ====== GPS ======
    function grabGPS() {
      if (!navigator.geolocation) return alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
      navigator.geolocation.getCurrentPosition(pos => {
        lat.value = pos.coords.latitude.toFixed(6);
        lng.value = pos.coords.longitude.toFixed(6);
      }, (err) => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î: ' + err.message), { enableHighAccuracy:true, timeout:8000 });
    }

    // ====== REGISTER PARCEL ======
    async function registerParcel(ev){
      ev.preventDefault();
      const body = {
        crop: crop.value,
        size_rai: parseFloat(sizeRai.value || 0),
        lat: parseFloat(lat.value), lng: parseFloat(lng.value)
      };
      let imgB64 = null;
      if (photo.files[0]) {
        imgB64 = await fileToBase64(photo.files[0]);
      }
      const res = await fetchJSON(`/parcels`, { method:'POST', body: JSON.stringify({ ...body, photo_base64: imgB64 }) });
      state.parcels.unshift(res);
      state.currentParcelId = res.id;
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      nav('status'); checkStatus();
    }
    function fileToBase64(file){
      return new Promise((ok, err) => {
        const rdr = new FileReader();
        rdr.onload = () => ok(String(rdr.result).split(',')[1]);
        rdr.onerror = err; rdr.readAsDataURL(file);
      });
    }

    // ====== STATUS (NDWI/LSWI) ======
    async function checkStatus(){
      const pid = state.currentParcelId;
      if (!pid) { setBadge(statusBadge,'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á', 'info'); statusText.textContent='‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô'; return; }
      setBadge(statusBadge,'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‚Ä¶','info'); statusText.textContent='';

      try {
        const s = await fetchJSON(`/parcels/${pid}/dryness`);
        ndwi.textContent = (s.ndwi ?? 0).toFixed(3);
        lswi.textContent = (s.lswi ?? 0).toFixed(3);
        updated.textContent = s.updated_at || '‚Äî';

        // simple threshold demo
        let tone='info', label='‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', tip='';
        if (s.readiness === 'dry')   { tone='good'; label='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (‡πÅ‡∏´‡πâ‡∏á)'; tip='‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î'; }
        if (s.readiness === 'wet')   { tone='bad';  label='‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å'; tip='‡∏£‡∏≠‡πÅ‡∏î‡∏î/‡∏á‡∏î‡∏ï‡∏±‡∏î'; }
        if (s.readiness === 'mid')   { tone='warn'; label='‡∏Å‡∏∂‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á'; tip='‡∏£‡∏≠‡∏≠‡∏µ‡∏Å 2‚Äì3 ‡∏ß‡∏±‡∏ô'; }
        setBadge(statusBadge,label,tone);
        statusText.textContent = tip;

        // update home card
        document.getElementById('homeStatus').textContent = label;
        document.getElementById('homeExplain').textContent = `NDWI ${ndwi.textContent}, LSWI ${lswi.textContent}`;
      } catch(e) {
        setBadge(statusBadge,'‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','bad');
        statusText.textContent = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      }
    }

    // ====== SHARE TO CHAT ======
    async function shareStatus(){
      if (!liff.isInClient()) { alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå'); return; }
      const msg = {
        type: "flex",
        altText: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏õ‡∏•‡∏á ‚Ä¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß",
        contents: flexDrynessCard({
          title: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏õ‡∏•‡∏á",
          desc: statusText.textContent || '',
          ndwi: ndwi.textContent, lswi: lswi.textContent,
          updated: updated.textContent
        })
      };
      await liff.sendMessages([msg]);
      alert('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ====== OFFER ======
    function prefillOffer(){
      moisture.value = (Number(lswi.textContent)||0) ? Math.max(0, 30 - Math.round(Number(lswi.textContent)*100)) : '';
    }
    async function createOffer(ev){
      ev.preventDefault();
      const pid = state.currentParcelId;
      if (!pid) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á');
      const body = {
        parcel_id: pid,
        qty_ton: parseFloat(qtyTon.value || 0),
        moisture: parseFloat(moisture.value || 0),
        note: note.value || ''
      };
      const r = await fetchJSON(`/offers`, { method:'POST', body: JSON.stringify(body) });
      alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß #' + r.code);
      if (liff.isInClient()) {
        await liff.sendMessages([{ type:"flex", altText:"‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤",
          contents: flexOfferCard({ code: r.code, price: r.target_price || "-", qty: body.qty_ton }) }]);
      }
      nav('deals'); loadDeals();
    }

    // ====== DEALS ======
    async function loadDeals(){
      const data = await fetchJSON(`/deals?me=farmer`);
      const box = document.getElementById('dealList'); box.innerHTML = '';
      if (!data.length) { box.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏µ‡∏•'; return; }
      for (const d of data) {
        const row = document.createElement('div');
        row.className = 'border rounded-xl p-3 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="font-medium">#${d.code} ‚Ä¢ ${d.company_name}</div>
            <div class="text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤: ${d.price} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å. ‚Ä¢ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì: ${d.qty_ton} ‡∏ï‡∏±‡∏ô</div>
            <div class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${d.status}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded-lg border" onclick="actDeal('${d.id}','accept')">‡∏£‡∏±‡∏ö</button>
            <button class="px-3 py-1 rounded-lg border" onclick="actDeal('${d.id}','reject')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          </div>`;
        box.appendChild(row);
      }
    }
    async function actDeal(id, action){
      await fetchJSON(`/deals/${id}/${action}`, { method:'POST' });
      loadDeals();
      alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ====== FLEX TEMPLATES ======
    function flexDrynessCard({title, desc, ndwi, lswi, updated}) {
      return {
        type: "bubble",
        hero: { type:"image", url:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop", size:"full", aspectRatio:"16:9", aspectMode:"cover" },
        body: {
          type:"box", layout:"vertical", spacing:"md", contents:[
            { type:"text", text:title, weight:"bold", size:"lg" },
            { type:"text", text:desc || "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", wrap:true, size:"sm", color:"#666666" },
            { type:"box", layout:"horizontal", contents:[
              { type:"box", layout:"vertical", contents:[
                { type:"text", text:"NDWI", size:"xs", color:"#666" },
                { type:"text", text:String(ndwi), weight:"bold" }
              ]},
              { type:"box", layout:"vertical", contents:[
                { type:"text", text:"LSWI", size:"xs", color:"#666" },
                { type:"text", text:String(lswi), weight:"bold" }
              ]},
              { type:"box", layout:"vertical", contents:[
                { type:"text", text:"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", size:"xs", color:"#666" },
                { type:"text", text:String(updated), weight:"bold" }
              ]}
            ]}
          ]
        }
      };
    }
    function flexOfferCard({code, price, qty}) {
      return {
        type:"bubble",
        body:{ type:"box", layout:"vertical", contents:[
          { type:"text", text:"‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", weight:"bold", size:"lg" },
          { type:"text", text:`‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠ #${code}`, size:"sm", color:"#666666" },
          { type:"box", layout:"baseline", spacing:"lg", contents:[
            { type:"text", text:"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì", size:"sm", color:"#666" },
            { type:"text", text:`${qty} ‡∏ï‡∏±‡∏ô`, weight:"bold" }
          ]},
          { type:"box", layout:"baseline", spacing:"lg", contents:[
            { type:"text", text:"‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤", size:"sm", color:"#666" },
            { type:"text", text:`${price} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.`, weight:"bold" }
          ]}
        ] }
      };
    }
  </script>
</body>
</html>
